<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小说写作助手</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-feather-alt"></i>
                <span>写作助手</span>
            </div>
            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-page="home">
                    <i class="fas fa-home"></i>
                    <span>首页</span>
                </a>
                <a href="#" class="nav-item" data-page="plot">
                    <i class="fas fa-dice"></i>
                    <span>随机情节</span>
                </a>
                <a href="#" class="nav-item" data-page="name">
                    <i class="fas fa-user"></i>
                    <span>随机名称</span>
                </a>

                <a href="#" class="nav-item" data-page="dialogue">
                    <i class="fas fa-comments"></i>
                    <span>随机对话</span>
                </a>
                <a href="#" class="nav-item" data-page="description">
                    <i class="fas fa-pen-fancy"></i>
                    <span>随机描写</span>
                </a>
                <a href="#" class="nav-item" data-page="idea">
                    <i class="fas fa-lightbulb"></i>
                    <span>随机灵感</span>
                </a>
                <a href="#" class="nav-item" data-page="material">
                    <i class="fas fa-book"></i>
                    <span>素材库</span>
                </a>
                <a href="#" class="nav-item" data-page="chat">
                    <i class="fas fa-robot"></i>
                    <span>AI助手</span>
                </a>
                <a href="#" class="nav-item" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>设置</span>
                </a>
                <a href="#" class="nav-item" data-page="skills">
                    <i class="fas fa-magic"></i>
                    <span>技能库</span>
                </a>
            </nav>
            <div class="theme-toggle">
                <button id="themeBtn" class="theme-btn">
                    <i class="fas fa-moon"></i>
                    <span>夜间模式</span>
                </button>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 首页 -->
            <section id="home" class="page active">
                <h1>欢迎使用小说写作助手</h1>
                
                <!-- AI快捷入口 -->
                <div class="hero-section">
                    <div class="hero-icon"><i class="fas fa-robot"></i></div>
                    <div class="hero-text">
                        <h2>AI 创作助手</h2>
                        <p>智能对话，探讨创作灵感</p>
                    </div>
                    <button class="btn ai-large" onclick="navigateTo('chat')">
                        <i class="fas fa-comments"></i> 开始对话
                    </button>
                </div>

                <h2 class="section-title">随机生成</h2>
                <div class="quick-actions">
                    <div class="action-card large" onclick="navigateTo('plot')">
                        <div class="card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="fas fa-dice"></i>
                        </div>
                        <div class="card-info">
                            <h3>随机情节</h3>
                            <p>冲突、爱情、冒险、悬疑...</p>
                        </div>
                        <div class="card-badge">AI</div>
                    </div>
                    <div class="action-card large" onclick="navigateTo('name')">
                        <div class="card-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="card-info">
                            <h3>随机名称</h3>
                            <p>人名、地名、武器，法宝...</p>
                        </div>
                        <div class="card-badge">AI</div>
                    </div>
                    <div class="action-card large" onclick="navigateTo('dialogue')">
                        <div class="card-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="card-info">
                            <h3>随机对话</h3>
                            <p>经典台词，经典对白</p>
                        </div>
                        <div class="card-badge">AI</div>
                    </div>
                    <div class="action-card large" onclick="navigateTo('description')">
                        <div class="card-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <i class="fas fa-pen-fancy"></i>
                        </div>
                        <div class="card-info">
                            <h3>随机描写</h3>
                            <p>环境、心理、战斗描写</p>
                        </div>
                        <div class="card-badge">AI</div>
                    </div>
                    <div class="action-card large" onclick="navigateTo('idea')">
                        <div class="card-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="card-info">
                            <h3>随机灵感</h3>
                            <p>创意点子，情节构思</p>
                        </div>
                        <div class="card-badge">AI</div>
                    </div>
                    <div class="action-card large" onclick="navigateTo('material')">
                        <div class="card-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="card-info">
                            <h3>素材库</h3>
                            <p>收藏灵感，记录好句</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 随机情节页 -->
            <section id="plot" class="page">
                <h1>🎲 随机情节生成</h1>
                <div class="plot-controls">
                    <select id="plotType" class="select-box">
                        <option value="all">全部类型</option>
                        <option value="conflict">冲突情节</option>
                        <option value="romance">爱情甜蜜</option>
                        <option value="sad">虐心情节</option>
                        <option value="adventure">冒险升级</option>
                        <option value="mystery">悬疑线索</option>
                        <option value="turn">意外转折</option>
                    </select>
                    <button class="btn primary" onclick="generatePlot()">
                        <i class="fas fa-sync-alt"></i> 随机生成
                    </button>
                    <button class="btn ai" onclick="generatePlotWithAI()">
                        <i class="fas fa-robot"></i> AI生成
                    </button>
                </div>
                <div class="plot-result" id="plotResult">
                    <p class="placeholder">点击上方按钮生成随机情节...</p>
                </div>
                <div class="plot-loading" id="plotLoading" style="display:none;">
                    <i class="fas fa-spinner fa-spin"></i> AI正在生成中...
                </div>
                <div class="plot-actions" id="plotActions" style="display:none;">
                    <button class="btn" onclick="saveToMaterial()">
                        <i class="fas fa-save"></i> 保存到素材库
                    </button>
                    <button class="btn secondary" onclick="regeneratePlot()">
                        <i class="fas fa-redo"></i> 换一个
                    </button>
                </div>
            </section>

            <!-- 随机名称页 -->
            <section id="name" class="page">
                <h1>🎲 随机名称生成</h1>
                
                <!-- 名称设置面板 -->
                <div class="name-settings">
                    <div class="setting-group">
                        <label>风格选择</label>
                        <select id="nameStyle" class="select-box">
                            <option value="xuanhuan">玄幻</option>
                            <option value="qihuan">奇幻</option>
                            <option value="lightnovel">轻小说</option>
                            <option value="urban">都市</option>
                            <option value="scifi">科幻</option>
                            <option value="history">历史</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>字数</label>
                        <select id="nameLength" class="select-box">
                            <option value="2">2个字</option>
                            <option value="3" selected>3个字</option>
                            <option value="4">4个字</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>定头字（可选）</label>
                        <input type="text" id="namePrefix" class="input-box" placeholder="例如：云、萧、墨" maxlength="1">
                    </div>
                </div>

                <div class="name-type-grid">
                    <div class="name-type-card" onclick="generateName('person')">
                        <i class="fas fa-user"></i>
                        <h3>人物姓名</h3>
                    </div>
                    <div class="name-type-card" onclick="generateName('place')">
                        <i class="fas fa-map-marker-alt"></i>
                        <h3>地名</h3>
                    </div>
                    <div class="name-type-card" onclick="generateName('faction')">
                        <i class="fas fa-flag"></i>
                        <h3>门派</h3>
                    </div>
                    <div class="name-type-card" onclick="generateName('weapon')">
                        <i class="fas fa-khanda"></i>
                        <h3>武器</h3>
                    </div>
                    <div class="name-type-card" onclick="generateName('technique')">
                        <i class="fas fa-magic"></i>
                        <h3>功法</h3>
                    </div>
                    <div class="name-type-card" onclick="generateName('treasure')">
                        <i class="fas fa-gem"></i>
                        <h3>法宝</h3>
                    </div>
                </div>
                <div class="name-result" id="nameResult">
                    <p class="placeholder">点击上方类型生成随机名称...</p>
                </div>
            </section>

            <!-- 随机对话页 -->
            <section id="dialogue" class="page">
                <h1>💬 随机对话生成</h1>
                <div class="plot-controls">
                    <button class="btn primary" onclick="generateDialogue()">
                        <i class="fas fa-sync-alt"></i> 随机生成
                    </button>
                    <button class="btn ai" onclick="generateDialogueWithAI()">
                        <i class="fas fa-robot"></i> AI生成
                    </button>
                </div>
                <div class="plot-result" id="dialogueResult">
                    <p class="placeholder">点击上方按钮生成随机对话...</p>
                </div>
                <div class="plot-actions" id="dialogueActions" style="display:none;">
                    <button class="btn" onclick="saveDialogue()">
                        <i class="fas fa-save"></i> 保存到素材库
                    </button>
                    <button class="btn secondary" onclick="generateDialogue()">
                        <i class="fas fa-redo"></i> 换一个
                    </button>
                </div>
            </section>

            <!-- 随机描写页 -->
            <section id="description" class="page">
                <h1>✍️ 随机描写生成</h1>
                <div class="plot-controls">
                    <select id="descType" class="select-box">
                        <option value="environment">环境描写</option>
                        <option value="psychology">心理描写</option>
                        <option value="battle">战斗描写</option>
                    </select>
                    <button class="btn primary" onclick="generateDescription()">
                        <i class="fas fa-sync-alt"></i> 随机生成
                    </button>
                    <button class="btn ai" onclick="generateDescriptionWithAI()">
                        <i class="fas fa-robot"></i> AI生成
                    </button>
                </div>
                <div class="plot-result" id="descResult">
                    <p class="placeholder">点击上方按钮生成随机描写...</p>
                </div>
                <div class="plot-actions" id="descActions" style="display:none;">
                    <button class="btn" onclick="saveDescription()">
                        <i class="fas fa-save"></i> 保存到素材库
                    </button>
                    <button class="btn secondary" onclick="generateDescription()">
                        <i class="fas fa-redo"></i> 换一个
                    </button>
                </div>
            </section>

            <!-- 随机灵感页 -->
            <section id="idea" class="page">
                <h1>💡 随机灵感生成</h1>
                <div class="plot-controls">
                    <button class="btn primary" onclick="generateIdea()">
                        <i class="fas fa-sync-alt"></i> 随机生成
                    </button>
                    <button class="btn ai" onclick="generateIdeaWithAI()">
                        <i class="fas fa-robot"></i> AI生成
                    </button>
                </div>
                <div class="plot-result" id="ideaResult">
                    <p class="placeholder">点击上方按钮生成随机灵感...</p>
                </div>
                <div class="plot-actions" id="ideaActions" style="display:none;">
                    <button class="btn" onclick="saveIdea()">
                        <i class="fas fa-save"></i> 保存到素材库
                    </button>
                    <button class="btn secondary" onclick="generateIdea()">
                        <i class="fas fa-redo"></i> 换一个
                    </button>
                </div>
            </section>



            <!-- 素材库页 -->
            <section id="material" class="page">
                <h1>📚 素材库</h1>
                
                <!-- 素材筛选 -->
                <div class="material-filter">
                    <button class="filter-btn active" data-filter="all">全部</button>
                    <button class="filter-btn" data-filter="plot">情节</button>
                    <button class="filter-btn" data-filter="name">名称</button>
                    <button class="filter-btn" data-filter="dialogue">对话</button>
                    <button class="filter-btn" data-filter="description">描写</button>
                    <button class="filter-btn" data-filter="idea">灵感</button>
                </div>
                
                <!-- 子分类筛选 -->
                <div class="sub-filter" id="subFilterContainer"></div>

                <div class="material-form">
                    <div style="display:flex;gap:12px;flex-wrap:wrap;">
                        <input type="text" id="materialTitle" class="input-box" placeholder="素材标题" style="flex:1;min-width:150px">
                        <select id="materialCategory" class="select-box" style="width:auto;min-width:120px">
                            <option value="plot">情节</option>
                            <option value="name">名称</option>
                            <option value="dialogue">对话</option>
                            <option value="description">描写</option>
                            <option value="idea">灵感</option>
                        </select>
                    </div>
                    <textarea id="materialContent" class="textarea-box" placeholder="素材内容..."></textarea>
                    <button class="btn primary" onclick="addMaterial()">
                        <i class="fas fa-plus"></i> 添加素材
                    </button>
                </div>
                <div class="material-list" id="materialList">
                    <!-- 素材列表 -->
                </div>
            </section>

            <!-- AI助手页 -->
            <section id="chat" class="page">
                <h1>🤖 AI助手</h1>
                
                <!-- 联网搜索开关 -->
                <div class="websearch-toggle">
                    <label class="switch">
                        <input type="checkbox" id="webSearchToggle" onchange="toggleWebSearch()">
                        <span class="slider"></span>
                    </label>
                    <span id="webSearchLabel">联网搜索已关闭</span>
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message bot">
                            <div class="message-avatar"><i class="fas fa-robot"></i></div>
                            <div class="message-content">
                                你好！我是小说创作助手，可以帮你：
                                <br>• 探讨情节设计
                                <br>• 生成角色设定
                                <br>• 优化文笔描写
                                <br>• 解决创作瓶颈
                                <br><br>有什么创作上的问题，尽管问我！
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="输入你的问题..." onkeypress="handleChatKeypress(event)">
                        <button class="btn primary" onclick="sendChat()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- 设置页 -->
            <section id="settings" class="page">
                <h1>⚙️ API 设置</h1>
                
                <div class="settings-grid">
                    <!-- GitHub 配置 -->
                    <div class="settings-card">
                        <div class="card-header">
                            <i class="fab fa-github"></i>
                            <h3>GitHub 配置</h3>
                        </div>
                        <div class="card-body">
                            <div class="setting-group">
                                <label>GitHub Token</label>
                                <input type="password" id="githubToken" class="input-box" placeholder="输入你的GitHub Token">
                            </div>
                            <p class="hint">Token需要gist权限</p>
                            <button class="btn ai" onclick="saveGitHubToken()">
                                <i class="fas fa-save"></i> 保存Token
                            </button>
                        </div>
                    </div>

                    <!-- AI模型配置 -->
                    <div class="settings-card">
                        <div class="card-header">
                            <i class="fas fa-robot"></i>
                            <h3>AI 模型配置</h3>
                        </div>
                        <div class="card-body">
                            <div class="models-list" id="modelsList"></div>
                            <button class="btn secondary" onclick="addModelConfig()">
                                <i class="fas fa-plus"></i> 添加模型
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 当前使用的模型 -->
                <div class="settings-card full-width">
                    <div class="card-header">
                        <i class="fas fa-check-circle"></i>
                        <h3>当前使用</h3>
                    </div>
                    <div class="card-body">
                        <select id="currentModel" class="select-box" onchange="switchModel()">
                            <option value="">请先添加模型配置</option>
                        </select>
                        <button class="btn ai" onclick="testApi()" style="margin-left:12px">
                            <i class="fas fa-plug"></i> 测试连接
                        </button>
                    </div>
                </div>

                <!-- API状态 -->
                <div class="api-status" id="apiStatus" style="display:none;">
                    <span class="status-indicator"></span>
                    <span id="statusText">未测试</span>
                </div>
            </section>

            <!-- 技能库页 -->
            <section id="skills" class="page">
                <h1>🧠 技能库</h1>
                
                <div class="skills-intro">
                    <p>AI助手可以学习和使用技能。你可以从GitHub Gist学习技能，或者让AI自动学习。</p>
                </div>

                <!-- 学习新技能 -->
                <div class="learn-skill-form">
                    <h3>📥 学习新技能</h3>
                    <div class="input-group">
                        <input type="text" id="gistUrl" class="input-box" placeholder="输入GitHub Gist URL或Gist ID">
                        <button class="btn ai" onclick="learnSkill()">
                            <i class="fas fa-graduation-cap"></i> 学习
                        </button>
                    </div>
                    <p class="hint">例如: https://gist.github.com/username/gist_id</p>
                </div>

                <!-- 技能列表 -->
                <div class="skills-list" id="skillsList">
                    <p style="text-align:center;color:var(--text-muted)">暂无已学习的技能</p>
                </div>

                <!-- 提示 -->
                <div class="skills-tips">
                    <h3>💡 如何让AI学习技能</h3>
                    <p>• 告诉AI："学习这个技能：[Gist链接]"</p>
                    <p>• 告诉AI："帮我创建一个XX技能"</p>
                    <p>• AI会自动分析和保存有用的技能</p>
                </div>
            </section>
        </main>
    </div>

    <script src="websearch.js"></script>
    <script src="app.js"></script>
    <script>
        // 注册 Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW registration failed'));
        }
    </script>
</body>
</html>
